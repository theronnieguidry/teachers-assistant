# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**TA (Teacher's Assistant)** - A Tauri v2 desktop application that generates print-ready K-6 teaching materials (worksheets, lesson plans, answer keys) using AI. Target users are homeschooling parents and elementary teachers.

**Repository**: https://github.com/theronnieguidry/teachers-assistant

## Commands

```bash
# Frontend development
npm install                    # Install dependencies
npm run dev                    # Start Vite dev server (frontend only)
npm run tauri dev              # Start Tauri dev mode (full app)
npm run tauri build            # Build production installer (Windows MSI/NSIS)

# Testing
npm test                       # Run unit tests in watch mode
npm run test:run               # Run unit tests once (333 tests)
npx playwright test            # Run E2E tests (144 tests across 3 browsers)
npx playwright test --project=chromium  # Run E2E in Chromium only

# Generation API (in generation-api/ directory)
cd generation-api
npm install
npm run dev                    # Start API server on localhost:3001
npm run test                   # Run API tests in watch mode
npm run test:run               # Run API tests once (98 tests)

# Database
npx supabase start             # Start local Supabase (requires Docker)
npx supabase db push           # Apply migrations

# GitHub workflow
gh issue list                  # View open issues
gh issue view <number>         # Read issue details
gh pr create                   # Create pull request
```

## Architecture

### Desktop App (Tauri v2 + React)

```
src/
├── components/
│   ├── ui/                    # shadcn/ui components (Button, Card, Dialog, Tabs, etc.)
│   ├── auth/                  # LoginForm, SignupForm, AuthGuard, AuthPage
│   ├── layout/                # AppLayout, Sidebar, Header, Dashboard
│   ├── panels/                # CreationPanel, ProjectsPanel, InspirationPanel
│   ├── wizard/                # 4-step creation wizard components
│   └── preview/               # HTMLRenderer, PreviewTabs, ProjectPreview
├── stores/                    # Zustand stores
│   ├── authStore.ts           # Authentication state + Supabase auth
│   ├── projectStore.ts        # Projects CRUD + versions
│   ├── wizardStore.ts         # Creation wizard state machine
│   ├── inspirationStore.ts    # Inspiration items (drag/drop)
│   └── toastStore.ts          # Toast notifications
├── services/
│   ├── supabase.ts            # Supabase client
│   ├── generation-api.ts      # Generation API client
│   └── tauri-bridge.ts        # Tauri IPC commands wrapper
├── lib/
│   ├── utils.ts               # cn() helper
│   └── validators.ts          # Zod schemas for forms
└── types/                     # TypeScript interfaces
```

**Key patterns:**
- State management: Zustand stores with optional persistence
- Forms: react-hook-form + zod schemas
- Tauri IPC: Commands in `src-tauri/src/commands/`, called via `tauri-bridge.ts`
- UI components: shadcn/ui + Radix primitives in `src/components/ui/`
- Error handling: ErrorBoundary at app root + toast notifications
- Styling: Tailwind CSS with CSS variables for theming

### Generation API (Node.js/Express)

```
generation-api/
├── src/
│   ├── routes/
│   │   ├── generate.ts        # POST /generate - main generation endpoint
│   │   ├── credits.ts         # GET /credits - user credit balance
│   │   ├── pdf.ts             # POST /pdf - HTML to PDF conversion
│   │   └── health.ts          # GET /health - health check
│   ├── services/
│   │   ├── ai-provider.ts     # Claude/OpenAI abstraction
│   │   ├── credits.ts         # Credit management (reserve/deduct/refund)
│   │   ├── generator.ts       # Main generation orchestration
│   │   └── inspiration-parser.ts  # URL/PDF content extraction
│   ├── middleware/
│   │   └── auth.ts            # JWT verification via Supabase
│   ├── prompts/
│   │   └── templates.ts       # AI prompt templates
│   └── types.ts               # API type definitions
└── package.json
```

**API Flow:**
1. Client sends JWT + generation request
2. Auth middleware verifies JWT with Supabase
3. Credits service reserves credits atomically
4. Generator calls AI provider (Claude or OpenAI)
5. Results stored in project_versions table
6. Credits deducted, HTML returned to client

### Backend (Supabase)

**Tables:**
- `profiles` - User profile data (extends auth.users)
- `credits` - Balance, lifetime_granted, lifetime_used
- `credit_transactions` - Audit log for credits
- `projects` - Title, prompt, grade, subject, options, status
- `project_versions` - worksheet_html, lesson_plan_html, answer_key_html

**Key Functions:**
- `handle_new_user()` - Trigger grants 50 trial credits on signup
- `reserve_credits()` - Atomic credit deduction
- `refund_credits()` - Refund on generation failure

### Output Format

- **HTML** is the canonical format (generated by AI, stored in database)
- **PDF** converted via browser print or server-side Playwright
- **Local files** saved to user-selected folder via Tauri file system commands

## Testing

### Test Suite Summary

| Suite | Tests | Location |
|-------|-------|----------|
| Frontend Unit | 333 | `src/__tests__/` |
| Generation API | 98 | `generation-api/src/__tests__/` |
| E2E (Playwright) | 144 | `e2e/` |
| **Total** | **575** | |

### Running Tests

```bash
# All unit tests
npm run test:run

# Generation API tests
cd generation-api && npm run test:run

# E2E tests (requires dev server on port 1420)
npx playwright test

# E2E single browser (faster)
npx playwright test --project=chromium

# E2E specific test file
npx playwright test e2e/wizard.spec.ts

# E2E with UI mode (debugging)
npx playwright test --ui
```

### E2E Test Structure

```
e2e/
├── auth.spec.ts           # Login/signup form tests (8 tests)
├── dashboard.spec.ts      # Main layout tests (8 tests)
├── wizard.spec.ts         # Creation wizard flow (10 tests)
├── inspiration.spec.ts    # Inspiration panel (10 tests)
├── projects.spec.ts       # Projects panel (4 tests)
└── accessibility.spec.ts  # A11Y tests (8 tests)
```

**E2E patterns:**
- Mock auth via `localStorage.setItem("sb-localhost-auth-token", ...)`
- Use `page.waitForSelector()` before assertions
- Radix Select: Click trigger, then `getByRole("option")`
- Dialog close: `getByRole("button", { name: "Close" })` (sr-only text)
- Use `{ exact: true }` for text that appears in multiple places

## Key Files

| File | Purpose |
|------|---------|
| `src/stores/wizardStore.ts` | Creation wizard state machine |
| `src/stores/toastStore.ts` | Toast notification system |
| `src/services/generation-api.ts` | API client with streaming support |
| `src/components/preview/PreviewTabs.tsx` | Tabbed preview with print/PDF |
| `generation-api/src/services/ai-provider.ts` | Claude/OpenAI abstraction |
| `generation-api/src/prompts/templates.ts` | AI prompt templates |
| `src-tauri/tauri.conf.json` | Tauri bundling configuration |
| `playwright.config.ts` | E2E test configuration |

## Environment Variables

**Frontend (.env):**
```env
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key
VITE_GENERATION_API_URL=http://localhost:3001
```

**Generation API (.env):**
```env
PORT=3001
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
ANTHROPIC_API_KEY=your-anthropic-api-key
OPENAI_API_KEY=your-openai-api-key
```

## Custom Skills

### `/qa` - Senior QA Engineer
Invokes a comprehensive QA review that:
1. Runs all unit tests (frontend + API)
2. Runs all E2E tests across 3 browsers
3. Analyzes failures and identifies root causes
4. Fixes failing tests (selectors, timing, code bugs)
5. Updates `QA-TESTING-PLAN.md` with results
6. Reports summary of issues found/fixed

**Usage**: Simply type `/qa` to start a full QA review.

**When adding new features**: The `/qa` skill expects new E2E tests to be added to `e2e/*.spec.ts` and documented in `QA-TESTING-PLAN.md`.

---

## Development Workflow

This project uses **issue-driven development**:

1. **Check for issues**: `gh issue list`
2. **Read issue details**: `gh issue view <number>`
3. **Implement** with appropriate unit and E2E tests
4. **Run full test suite**: `npm run test:run && npx playwright test`
5. **Commit** with descriptive message referencing issue
6. **Create PR**: `gh pr create`

### Issue Templates

- `.github/ISSUE_TEMPLATE/feature_request.md` - New features
- `.github/ISSUE_TEMPLATE/bug_report.md` - Bug reports
- `.github/ISSUE_TEMPLATE/task.md` - General tasks

## Design Constraints

- **Offline access**: Past projects viewable without internet (HTML stored locally)
- **Print-optimized**: All outputs render correctly on US Letter paper
- **Child-friendly**: Clean fonts, colorful UI, large touch targets
- **Credits system**: Server-enforced, atomic deduction with refund on failure
- **Grade levels**: K-6 with age-appropriate vocabulary and complexity

## Build & Deploy

```bash
# Build Windows installer
npm run tauri build

# Output: src-tauri/target/release/bundle/
#   - msi/TA Teachers Assistant_0.1.0_x64_en-US.msi
#   - nsis/TA Teachers Assistant_0.1.0_x64-setup.exe
```

## Known Issues & Fixes

### Radix UI Select in Tests
- JSDOM doesn't support `hasPointerCapture` - avoid testing Select interactions in unit tests
- E2E tests work fine with `page.locator('[role="combobox"]').click()`

### Firefox E2E Timing
- Firefox has slower Supabase connection handling
- Use longer timeouts for API-dependent assertions: `toBeVisible({ timeout: 15000 })`

### CardTitle Accessibility
- shadcn/ui `CardTitle` renders as `<div>`, not a heading
- Use `getByText()` instead of `getByRole("heading")` in tests

## Archived Files

The `archive/` directory contains old project files from a previous implementation. These are not used by TA and should not be referenced for new development.
