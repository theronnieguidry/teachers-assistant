# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**TA (Teacher's Assistant)** - A Tauri v2 desktop application that generates print-ready K-6 teaching materials (worksheets, lesson plans, answer keys) using AI. Target users are homeschooling parents and elementary teachers.

## Commands

```bash
# Frontend development
npm install                    # Install dependencies
npm run dev                    # Start Vite dev server (frontend only)
npm run tauri dev              # Start Tauri dev mode (full app)
npm run tauri build            # Build production installer (Windows MSI/NSIS)
npm run test                   # Run unit tests in watch mode
npm run test:run               # Run unit tests once

# Generation API (in generation-api/ directory)
cd generation-api
npm install
npm run dev                    # Start API server on localhost:3001
npm run test                   # Run API tests in watch mode
npm run test:run               # Run API tests once

# Database
npx supabase start             # Start local Supabase (requires Docker)
npx supabase db push           # Apply migrations
```

## Architecture

### Desktop App (Tauri v2 + React)

```
src/
├── components/
│   ├── ui/                    # shadcn/ui components (Button, Card, Dialog, Tabs, etc.)
│   ├── auth/                  # LoginForm, SignupForm, AuthGuard, AuthPage
│   ├── layout/                # AppLayout, Sidebar, Header, Dashboard
│   ├── panels/                # CreationPanel, ProjectsPanel, InspirationPanel
│   ├── wizard/                # 4-step creation wizard components
│   └── preview/               # HTMLRenderer, PreviewTabs, ProjectPreview
├── stores/                    # Zustand stores
│   ├── authStore.ts           # Authentication state + Supabase auth
│   ├── projectStore.ts        # Projects CRUD + versions
│   ├── wizardStore.ts         # Creation wizard state machine
│   ├── inspirationStore.ts    # Inspiration items (drag/drop)
│   └── toastStore.ts          # Toast notifications
├── services/
│   ├── supabase.ts            # Supabase client
│   ├── generation-api.ts      # Generation API client
│   └── tauri-bridge.ts        # Tauri IPC commands wrapper
├── lib/
│   ├── utils.ts               # cn() helper
│   └── validators.ts          # Zod schemas for forms
└── types/                     # TypeScript interfaces
```

**Key patterns:**
- State management: Zustand stores with optional persistence
- Forms: react-hook-form + zod schemas
- Tauri IPC: Commands in `src-tauri/src/commands/`, called via `tauri-bridge.ts`
- UI components: shadcn/ui + Radix primitives in `src/components/ui/`
- Error handling: ErrorBoundary at app root + toast notifications
- Styling: Tailwind CSS with CSS variables for theming

### Generation API (Node.js/Express)

```
generation-api/
├── src/
│   ├── routes/
│   │   ├── generate.ts        # POST /generate - main generation endpoint
│   │   ├── credits.ts         # GET /credits - user credit balance
│   │   ├── pdf.ts             # POST /pdf - HTML to PDF conversion
│   │   └── health.ts          # GET /health - health check
│   ├── services/
│   │   ├── ai-provider.ts     # Claude/OpenAI abstraction
│   │   ├── credits.ts         # Credit management (reserve/deduct/refund)
│   │   ├── generator.ts       # Main generation orchestration
│   │   └── inspiration-parser.ts  # URL/PDF content extraction
│   ├── middleware/
│   │   └── auth.ts            # JWT verification via Supabase
│   ├── prompts/
│   │   └── templates.ts       # AI prompt templates
│   └── types.ts               # API type definitions
└── package.json
```

**API Flow:**
1. Client sends JWT + generation request
2. Auth middleware verifies JWT with Supabase
3. Credits service reserves credits atomically
4. Generator calls AI provider (Claude or OpenAI)
5. Results stored in project_versions table
6. Credits deducted, HTML returned to client

### Backend (Supabase)

**Tables:**
- `profiles` - User profile data (extends auth.users)
- `credits` - Balance, lifetime_granted, lifetime_used
- `credit_transactions` - Audit log for credits
- `projects` - Title, prompt, grade, subject, options, status
- `project_versions` - worksheet_html, lesson_plan_html, answer_key_html

**Key Functions:**
- `handle_new_user()` - Trigger grants 50 trial credits on signup
- `reserve_credits()` - Atomic credit deduction
- `refund_credits()` - Refund on generation failure

### Output Format

- **HTML** is the canonical format (generated by AI, stored in database)
- **PDF** converted via browser print or server-side Playwright
- **Local files** saved to user-selected folder via Tauri file system commands

## Key Files

| File | Purpose |
|------|---------|
| `src/stores/wizardStore.ts` | Creation wizard state machine |
| `src/stores/toastStore.ts` | Toast notification system |
| `src/services/generation-api.ts` | API client with streaming support |
| `src/components/preview/PreviewTabs.tsx` | Tabbed preview with print/PDF |
| `generation-api/src/services/ai-provider.ts` | Claude/OpenAI abstraction |
| `generation-api/src/prompts/templates.ts` | AI prompt templates |
| `src-tauri/tauri.conf.json` | Tauri bundling configuration |

## Testing

**Test files location:** `src/__tests__/` and `generation-api/src/__tests__/`

**Coverage:**
- Frontend: 200 tests (stores, validators, components)
- Generation API: 82 tests (routes, services, middleware)

**Run tests:**
```bash
# Frontend
npm run test:run

# Generation API
cd generation-api && npm run test:run
```

## Environment Variables

**Frontend (.env):**
```env
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key
VITE_GENERATION_API_URL=http://localhost:3001
```

**Generation API (.env):**
```env
PORT=3001
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
ANTHROPIC_API_KEY=your-anthropic-api-key
OPENAI_API_KEY=your-openai-api-key
```

## Design Constraints

- **Offline access**: Past projects viewable without internet (HTML stored locally)
- **Print-optimized**: All outputs render correctly on US Letter paper
- **Child-friendly**: Clean fonts, colorful UI, large touch targets
- **Credits system**: Server-enforced, atomic deduction with refund on failure
- **Grade levels**: K-6 with age-appropriate vocabulary and complexity

## Build & Deploy

```bash
# Build Windows installer
npm run tauri build

# Output: src-tauri/target/release/bundle/
#   - msi/TA Teachers Assistant_0.1.0_x64_en-US.msi
#   - nsis/TA Teachers Assistant_0.1.0_x64-setup.exe
```

## Archived Files

The `archive/` directory contains old project files from a previous implementation. These are not used by TA and should not be referenced for new development.
